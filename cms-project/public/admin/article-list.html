<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title></title>
    <!-- Bootstrap -->
    <!-- Bootstrap -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="css/base.css"/>
    <style>
        nav {
            margin: 0 auto;

        }

        img {
            display: block;
            width: 100px;
            height: 100px;
        }

        @media (min-width: 768px) {
            .modal-dialog {
                width: 882px;
                margin: 30px auto;
            }
        }
    </style>
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">CMS管理系统</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- <li><a href="#">Link</a></li> -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">
                        admin
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="#">个人资料</a></li>
                        <li><a href="#">通知信息</a></li>
                        <li><a href="#">收到的评论</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="#">退出登录</a></li>
                    </ul>
                </li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>
<div class="main">
    <div class="left-side">
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading1">
                    <h4 class="panel-title">
                        <a role="button" href="#">
                            <span class="glyphicon glyphicon-fire"></span>
                            信息面板
                        </a>
                    </h4>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading2">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapse2"
                           aria-expanded="false" aria-controls="collapseTwo">
                            <span class="glyphicon glyphicon-tasks"></span>
                            文章管理
                        </a>
                    </h4>
                </div>
                <div id="collapse2" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="article-list.html">
                                <span class="glyphicon glyphicon-th-list"></span>
                                文章列表
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="article-add.html">
                                <span class="glyphicon glyphicon-pencil"></span>
                                发布文章
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading3">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapse3"
                           aria-expanded="false" aria-controls="collapseThree">
                            <span class="glyphicon glyphicon-equalizer"></span>
                            栏目管理
                        </a>
                    </h4>
                </div>
                <div id="collapse3" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="category-list.html">
                                <span class="glyphicon glyphicon-list"></span>
                                栏目列表
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="category-add.html">
                                <span class="glyphicon glyphicon-plus"></span>
                                添加栏目
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading4">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapse4"
                           aria-expanded="false" aria-controls="collapseThree">
                            <span class="glyphicon glyphicon-bullhorn"></span>
                            公告管理
                        </a>
                    </h4>
                </div>
                <div id="collapse4" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="#">
                                <span class="glyphicon glyphicon-bell"></span>
                                公告列表
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="#">
                                <span class="glyphicon glyphicon-send"></span>
                                发布公告
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading5">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapse5"
                           aria-expanded="false" aria-controls="collapseThree">
                            <span class="glyphicon glyphicon-comment"></span>
                            评论管理
                        </a>
                    </h4>
                </div>
                <div id="collapse5" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="#">
                                <span class="glyphicon glyphicon-paperclip"></span>
                                评论列表
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading6">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapse6"
                           aria-expanded="false" aria-controls="collapseThree">
                            <span class="glyphicon glyphicon-user"></span>
                            用户管理
                        </a>
                    </h4>
                </div>
                <div id="collapse6" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="#">
                                <span class="glyphicon glyphicon-tags"></span>
                                用户组
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="user-list.html">
                                <span class="glyphicon glyphicon-list-alt"></span>
                                用户列表
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="right-content">
        <!-- 警告框 -->
        <div class="alert alert-info" role="alert">
            <h3>注意</h3>
            <div>暂时显示全部文章，不区分版块</div>
        </div>
        <!-- 表格 -->
        <div class="panel panel-primary">
            <div class="panel-heading">文章列表</div>
            <div class="panel-body">
                <!-- Table -->
                <table class="table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>版块</th>
                        <th>主图</th>
                        <th>标题</th>
                        <th>发布日期</th>
                        <th>更新日期</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!--                    <tr>-->
                    <!--                        <td>1</td>-->
                    <!--                        <td>科技</td>-->
                    <!--                        <td></td>-->
                    <!--                        <td>标题</td>-->
                    <!--                        <td>2019-30-28 15:30:12</td>-->
                    <!--                        <td>2019-30-28 15:30:12</td>-->
                    <!--                        <td>-->
                    <!--                            <button type="button" class="btn btn-default btn-xs">-->
                    <!--                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> 编辑-->
                    <!--                            </button>-->
                    <!--                            <button type="button" class="btn btn-default btn-xs">-->
                    <!--                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> 删除-->
                    <!--                            </button>-->
                    <!--                        </td>-->
                    <!--                    </tr>-->

                    </tbody>
                </table>
            </div>


        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li>
                    <a href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">5</a></li>
                <li>
                    <a href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <!-- modal模态框 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="deleteModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">确定</h4>
                </div>
                <div class="modal-body">
                    <p>确定删除该用户吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmBtn">确定</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!-- 编辑模态框 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="editModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">编辑</h4>
                </div>
                <div class="modal-body">
                    <!-- 表单 -->
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                标题
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="title" placeholder="请输入文章标题" name="title">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                描述
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-10">
                            <textarea class="form-control" placeholder="博客内容的简单摘要" rows="3"
                                      name="description" id="description"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                版块
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-10">
                                <select class="form-control" id="category_id" name="category_id">
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                主图
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-10">
                                <div class="clearfix">
                                    <input type="file" id="upload" class="pull-left">
                                    <button type="button" class="btn btn-default pull-right" id="upload-btn">上传</button>
                                    <!--隐藏数据-->
                                    <input type="hidden" name="main_photo" id="main_photo">
                                </div>
                                <div class="preview">
                                    <img src="" alt="">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-2 control-label">
                                内容
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-10">
                                <div id="editor">
                                    <input type="hidden" name="content" id="content">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button type="button" class="btn btn-primary" id="releaseBtn">发布文章</button>
                            </div>
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="editBtn">保存</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</div>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="lib/jquery-3.3.1.min.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="lib/bootstrap/js/bootstrap.min.js"></script>
<script src="./lib/wangEditor/wangEditor.min.js"></script>
<script>

    var E = window.wangEditor;
    var editor = new E('#editor');
    //配置服务器地址
    editor.customConfig.uploadImgServer = '/admin/upload/common';
    editor.customConfig.uploadFileName = 'file';
    var $content = $('#content');
    editor.customConfig.onchange = function (html) {
        // 监控变化，同步更新到 textarea
        $content.val(html)
    };
    editor.create();


</script>
<script>
    $(document).ready(function () {

        //获取文章列表
        $.getJSON('/admin/article/list', {pagesize: 10, pageindex: 1}, function (res) {
            if (res.status) {
                var html = "";
                res.msg.forEach(function (item) {
                    html += `             <tr>
                        <td>${item.article_id}</td>
                        <td>${item.name}</td>
                        <td><img src='${item.main_photo}' alt=""></td>
                        <td>${item.title}</td>
                        <td>${item.create_time}</td>
                        <td>${item.update_time}</td>
                        <td>
                            <button type="button" class="btn btn-default btn-xs edit" data-id="${item.article_id}">
                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> 编辑
                            </button>
                            <button type="button" class="btn btn-default btn-xs delete" data-id="${item.article_id}">
                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> 删除
                            </button>
                        </td>
                    </tr>`
                })
                $('table tbody').append(html);
            }

        })
        // 删除操作
        $("tbody").on("click", ".delete", function () {
            $("#deleteModal").modal("show");
            // 获取要删除的id
            var uid = $(this).data("id");
            console.log(uid);
            // 转存id
            $("#confirmBtn").data("id", uid);
        })


        // 确认删除
        $("#confirmBtn").click(function () {
            //提取id
            var uid = $(this).data("id");
            console.log(uid);
            $.post("/admin/article/del", {
                article_id: uid
            }, function (result) {
                if (result.status) {
                    $("#deleteModal").modal("hide");
                    //刷新页面 location.reload()
                    // window.location.reload();
                    $("tbody>tr").each(function () {
                        var $td = $(this).find("td").eq(0);
                        var id = $td.text();
                        if (id == uid) {
                            $(this).remove();
                        }


                    })
                }
            })
        })
        // 编辑操作
        $("tbody").on("click", ".edit", function () {
            $.getJSON('/admin/category/firstLevel', function (res) {
                if (res.status) {
                    var html = "";
                    res.data.forEach(function (item) {
                        html += `<option value="${item.category_id}">${item.name}</option>`;
                    })
                    $('#category_id').append(html);
                }
            })
            $("#editModal").modal("show");
            // 获取要删除的id
            var uid = $(this).data("id");
            // console.log(uid);
            $.getJSON("/admin/article/detail", {
                article_id: uid
            }, function (result) {
                if (result.status) {
                    $('#title').val(result.msg.title);
                    $('#description').val(result.msg.description);
                    $('#category_id').val(result.msg.category_id);
                    $('.preview img').attr('src',result.msg.main_photo);
                    $('#main_photo').val(result.msg.main_photo);
                    editor.txt.html(result.msg.content);
                }
            })
            $("#editBtn").data("id", uid);
        })


        // 确定编辑
        $("#editBtn").click(function () {
            //提取id
            var uname = $("#InputUsername").val();
            var ufull = $("#InputFullname").val();
            var utel = $("#InputTel").val();

            //提取id
            var uid = $(this).data("id");
            $.post("/users/edit", {
                users_id: uid,
                username: uname,
                fullname: ufull,
                tel: utel
            }, function (result) {
                console.log(result)
                if (result.status) {
                    $("#editModal").modal("hide");
                    // 	//刷新页面 location.reload()
                    // 	// window.location.reload();
                    $("tbody>tr").each(function () {
                        var $td = $(this).find("td").eq(0);
                        var id = $.trim($td.text());
                        if (id == uid) {
                            // $(this).remove();
                            $(this).find("td:eq(1)").text(uname);
                            $(this).find("td:eq(2)").text(ufull);
                            $(this).find("td:eq(3)").text(utel);

                        }
                    })
                }
            })
        })

    })
</script>
</body>

</html>